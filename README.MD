# <img src="images/ai-foundry.png" height="32" alt="Azure AI Foundry" /> Microsoft Foundry Workflows - Payment Service Demo


A declarative workflow demo using Microsoft Foundry agents for processing service payments. Learn more [here](https://learn.microsoft.com/en-us/azure/ai-foundry/agents/concepts/workflow?view=foundry)

## ğŸ”§ Prerequisites

- [Python 3.11 or later](https://www.python.org/) installed locally
- [Azure CLI](https://docs.microsoft.com/cli/azure/install-azure-cli) installed and logged in
- Access to an Azure AI Foundry project

## âš™ï¸ Deployment

This sample uses [`azd`](https://learn.microsoft.com/azure/developer/azure-developer-cli/) and a bicep template to deploy all Azure resources:

**Clone and Set up**
```bash
    git clone <repository-url>
    cd gbb-ai-foundry-workflows
    pip install -r requirements.txt
```

**Create the infrastructure**
```bash
   # Login to Azure (if not already logged in)
   az login

   # Initialize the project (if running for the first time)
   azd init

   # Deploy infrastructure and application to Azure
   azd up
```

##  Running the Workflow

```bash
    cd src
    python main.py
```

## Project Structure

```
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py                         # Main entry point
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ factory.py                  # Generic agent factory
â”‚   â”‚   â””â”€â”€ models.py                   # Agent output schemas (Pydantic models)
â”‚   â”œâ”€â”€ plugins/
â”‚   â”‚   â””â”€â”€ implementations.py                  # Payment business logic and mock data
â”‚   â”‚   â””â”€â”€ payment_tools.py            # Azure AI FunctionTool wrappers
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ runner.py                   # Workflow execution runner
â”œâ”€â”€ workflows/
â”‚   â”œâ”€â”€ service-payment-workflow.yaml   # Declarative workflow definition
â”‚   â””â”€â”€ agents/
â”‚       â””â”€â”€ service_agents.yaml         # Agent configurations
â”œâ”€â”€ requirements.txt                    # Python dependencies
â”œâ”€â”€ .env                                # Environment variables
â””â”€â”€ README.MD
```

## Workflow Overview

![Payment Workflow](images/workflow.png)

The payment workflow includes 4 agents:

| Agent | Purpose |
|-------|---------|
| `ServiceSelectionAgent` | Helps user select a service to pay |
| `GetBalanceAgent` | Retrieves account balance |
| `BalanceAndConfirmationAgent` | Confirms payment amount with user |
| `PayServiceAgent` | Executes the payment |

### Flow

1. User selects a service from their favorites
2. System retrieves account balance
3. System retrieves latest bill amount
4. User confirms payment 
4. Payment is executed
5. Receipt is displayed

## Sample Conversations

### âœ… Successful Payment (Sufficient Balance)

```
ğŸ§‘ User: mis servicios favoritos

ğŸ¤– ServiceSelectionAgent: Estos son tus servicios favoritos:
   â€¢ Luz del Sur (Electricidad) â€” id SVC001
   â€¢ Sedapal (Agua) â€” id SVC002
   â€¢ Netflix (Streaming) â€” id SVC004
   Â¿CuÃ¡l deseas pagar? Puedes responder con el nombre o con el id.

ğŸ§‘ User: netflix

ğŸ¤– ServiceSelectionAgent: Â¿Confirmas que deseas pagar Netflix?

ğŸ§‘ User: si

ğŸ¤– ServiceSelectionAgent: Confirmado: procederÃ© a pagar Netflix (id SVC004).

ğŸ¤– LatestBillAndConfirmationAgent: El monto a pagar por Netflix es 44.90 S/. 
   Tu saldo disponible es 1000.5 S/. Â¿Confirmas el pago?

ğŸ§‘ User: si

ğŸ¤– LatestBillAndConfirmationAgent: Pago confirmado. Se iniciarÃ¡ el pago de 
   Netflix por 44.90 S/. El sistema verificarÃ¡ fondos y procesarÃ¡ la transacciÃ³n.

âœ… Pago confirmado â€” ReceiptId: RCP-B5C2DB72
   Pago de 44.90 S/. a Netflix realizado exitosamente. 
   Fecha: 12/23/2025 7:20 PM
   Â¿Deseas realizar otro pago?
```

### âŒ Insufficient Balance

```
ğŸ§‘ User: quiero pagar uno de mis servicios registrados

ğŸ¤– ServiceSelectionAgent: Estos son tus servicios registrados:
   â€¢ Luz del Sur (Electricidad) â€” ID: SVC001
   â€¢ Sedapal (Agua) â€” ID: SVC002
   â€¢ Netflix (Streaming) â€” ID: SVC004
   Â¿CuÃ¡l deseas pagar? Indica el nombre o el ID del servicio.

ğŸ§‘ User: si, seria netflix

ğŸ¤– ServiceSelectionAgent: Has seleccionado Netflix. Â¿Confirmas que deseas pagar Netflix?

ğŸ§‘ User: si!

ğŸ¤– ServiceSelectionAgent: ConfirmaciÃ³n recibida: procederÃ© a iniciar el pago 
   de Netflix (ID: SVC004).

ğŸ¤– LatestBillAndConfirmationAgent: El monto a pagar por Netflix es 44.90 S/. 
   Tu saldo disponible es 20.5 S/. Â¿Confirmas el pago?

ğŸ§‘ User: si

ğŸ¤– LatestBillAndConfirmationAgent: Pago confirmado. Se iniciarÃ¡ el pago de 
   44.90 S/. por Netflix (ID: SVC004). El sistema verificarÃ¡ fondos y 
   completarÃ¡ la transacciÃ³n.

âŒ Fondos insuficientes: El monto a pagar (44.9 S/.) 
   es mayor que tu saldo disponible (20.5 S/.).
   No se realizÃ³ el pago. Â¿Deseas pagar otro servicio?
```

## Troubleshooting

### Slow startup

The first run may take 7-10 seconds due to Azure authentication cold start. Subsequent runs are faster.

### Azure CLI credential errors

Make sure you're logged in:

```bash
az login
az account show
```

### Missing agents

Agents are created automatically on startup. If you see errors about missing agents, check your Foundry endpoint configuration.